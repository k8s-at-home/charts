#
# IMPORTANT NOTE
#
# This chart inherits from our common library chart. You can check the default values/options here:
# https://github.com/k8s-at-home/library-charts/tree/main/charts/stable/common/values.yaml
#

image:
  # -- image repository
  repository: markhnsn/rtl_433_prometheus
  # -- image tag
  tag: latest
  # -- image pull policy
  pullPolicy: IfNotPresent

# -- Configures service settings for the chart.
# @default -- See values.yaml
service:
  main:
    ports:
      http:
        enabled: false
      metrics:
        enabled: true
        protocol: TCP
        port: 9550

metrics:
  # -- Enable and configure a Prometheus serviceMonitor for the chart under this key.
  # @default -- See values.yaml
  enabled: false
  serviceMonitor:
    # -- The interval field must use minutes for the padding to calculate properly.
    interval: 60m
    scrapeTimeout: 1m
    labels: {}
  # -- Enable and configure Prometheus Rules for the chart under this key.

resources:
  requests:
    smarter-devices/rtl_sdr: "1"
  limits:
    smarter-devices/rtl_sdr: "1"

command: ["/bin/bash"]
args:
  - -c
  - "export BUSNUM=$(udevadm info --name /dev/rtl_sdr | grep BUSNUM | awk -F = '{ print $2 }') && \
    export DEVNUM=$(udevadm info --name /dev/rtl_sdr | grep DEVNUM | awk -F = '{ print $2 }') &&\
    export DEVDIR=/dev/bus/usb/$BUSNUM && \
    export DEVPATH=$DEVDIR/$DEVNUM && \
    mkdir -p /dev/bus/usb/$BUSNUM && \
    ln -s /dev/rtl_sdr $DEVPATH && \
    echo \"Symlinking $DEVPATH -> /dev/rtl_sdr\" && \
    /rtl_433_prometheus --subprocess '/rtl_433 -F json -M newmodel'"